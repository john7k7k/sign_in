<template>
    <v-container>
      
      <v-card class="mx-auto px-8 py-11  " max-width="344"  color="white" >
        <div class="container">
        
          <v-form v-model="form" @submit.prevent="onSubmit" >
        <div class="text-subtitle-1 text-black">使用者名稱</div>  
        <v-text-field
            v-model="account"
            :readonly="loading"
            :rules="[required]"
            class="mb-2 "
            clearable
            placeholder="Enter your UserName"
          ></v-text-field>
          <div
        class="text-black text-subtitle-1  d-flex align-center justify-space-between"
      >
        密碼

        <a
          class="text-caption text-decoration-underline text-white"
          href="#"
          rel="noopener noreferrer"
          target="_blank"
          v-show="false"
        >
          忘記密碼?</a
        >
      </div>
          <v-text-field
            :append-inner-icon="visible ? 'mdi-eye-off' : 'mdi-eye'"
            :type="visible ? 'text' : 'password'"
            v-model="password"
            :readonly="loading"
            :rules="[required]"
            @click:append-inner="visible = !visible"
            
            placeholder="Enter your password"
          ></v-text-field>
  
          <br>
  
          
          <v-snackbar :timeout="2000" color="blue-grey" rounded="pill">
      <template v-slot:activator="{ props }">
        <v-btn
            rounded="pill"
            :disabled="!form"
            :loading="loading"
            block
            color="success"
            size="large"
            type="submit"
            variant="elevated"
            class="mb-3"
            v-bind="props"
          >
            登入
          </v-btn>
      </template>
    </v-snackbar>
          </v-form>
        </div>
      
        
      </v-card>
    
    </v-container>
  </template>
  
  <script>
  import axios from 'axios';
  const CryptoJS = require("crypto-js");
    export default {
      data: () => ({
        form: false,
        salt:  "kowkoww151s5ww",
        account: null,
        password: null,
        token:'',
        visible: false,
        loading: false,
      }),
  
      methods: {
        onSubmit () {
          const saltedPassword = this.password + this.salt;
          const hashedPassword = CryptoJS.MD5(saltedPassword).toString();
          if (!this.form) return
          this.loading = true
          axios.post(
            "http://20.89.131.34:443/api/v1/account/login",
            {
              "username":this.account,
              "password":hashedPassword
            },
          )
          .then(res=> {
              console.log(res);
              this.loading = false;
              if(res.status == 200){
                const fish001Data = res.data.fishesID["002"];
                const fish20Values = [];
                const fish21Values = [];
                const fish22Values = [];
                const fish002Data = res.data.fishesID["003"];
                const fish30Values = [];
                const fish31Values = [];
                const fish32Values = [];
                if( Object.hasOwn(res.data.fishesID,"002")){
                  Object.entries(fish001Data).forEach(([key, value]) => {
                    if (value === 1) {
                      fish21Values.push(key);
                    } else if (value === 2) {
                      fish22Values.push(key)
                    } else {
                      fish20Values.push(key)
                    }
                  });
                }

                if(Object.hasOwn(res.data.fishesID,"003")){
                  
                  Object.entries(fish002Data).forEach(([key, value]) => {
                    if (value === 1) {
                      fish31Values.push(key)
                    } else if (value === 2) {
                      fish32Values.push(key)
                    } else {
                      fish30Values.push(key)
                    }
                  });
                }
                localStorage.setItem("fish20", JSON.stringify(fish20Values));
                localStorage.setItem("fish21", JSON.stringify(fish21Values));
                localStorage.setItem("fish22", JSON.stringify(fish22Values));
                localStorage.setItem("fish30", JSON.stringify(fish30Values));
                localStorage.setItem("fish31", JSON.stringify(fish31Values));
                localStorage.setItem("fish32", JSON.stringify(fish32Values));
                localStorage.setItem("UserName",res.data.username)
                localStorage.setItem("UserEmail",res.data.email)
                localStorage.setItem("UserLevel",res.data.level)
                localStorage.setItem("UserSection",res.data.section)
                const timestamp = res.data.registrationTime
                const date = new Date(timestamp);
                const year = date.getFullYear();
                const month = date.getMonth() + 1; 
                const day = date.getDate();
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const seconds = date.getSeconds();
                const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                localStorage.setItem("registrationTime",formattedDate)
                document.cookie = "token=" + res.data.token + "; path=/";
                window.location.replace(`http://20.89.131.34:443/static/dist/home`); //括號內加上+res.data.token http://20.89.131.34:443/static/dist/home
              }
              else
              alert("登入失敗")
          })
          .catch(err=> {
              console.log(err);
              this.loading = false;
              alert('登入失敗');
          })
        },
        required (v) {
        return !!v || 'Field is required'
      },
        
      }
    }
  </script>
